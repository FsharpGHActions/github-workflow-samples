# SPDX-FileCopyrightText: Copyright (C) 2025 FabrÃ­cio Barros Cabral
# SPDX-License-Identifier: MIT
---
# yamllint disable rule:line-length
name: c-cpp-build-template
'on':
  workflow_call:
defaults:
  run:
    shell: bash -xeuo pipefail {0}
permissions:
  contents: read
jobs:
  c-cpp-linux-build-template:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          persist-credentials: false
      - name: Configure APT cache
        uses: actions/cache@v4
        with:
          path: /var/cache/apt/archives
          key: ${{ runner.os }}-apt-${{ hashFiles('**/apt-packages.txt') }}
          restore-keys: ${{ runner.os }}-apt-
      - name: Detect working directory
        id: detect
        run: |
          if [[ -d python ]]; then
            echo "dir=python" >> "${GITHUB_OUTPUT}"
          else
            echo "dir=." >> "${GITHUB_OUTPUT}"
          fi
      - name: Install dependencies
        working-directory: ${{ steps.detect.outputs.dir }}
        run: |
          if [[ -s apt-packages.txt ]]; then
            sudo apt-get update
            xargs sudo apt-get install -y \
              --no-install-recommends < apt-packages.txt
          fi
      - name: Configure and build
        working-directory: ${{ steps.detect.outputs.dir }}
        run: |
          [[ -x ./autogen.sh ]] && ./autogen.sh
          [[ -x ./configure ]] && ./configure
          [[ -s Makefile ]] || {
            echo "I couldn't find an autogen.sh, configure, or Makefile."
            echo "Please check your files."
            exit 1
          }
          make
      - name: Get properties from configure.ac
        working-directory: ${{ steps.detect.outputs.dir }}
        id: props
        run: |
          name="$(sed -n 's/AC_INIT(\[\([^]]*\)\],.*/\1/p' configure.ac)"
          echo "name=${name}" >> "${GITHUB_OUTPUT}"
          version="$(sed -n 's/AC_INIT(\[[^]]*\], \[\([^]]*\)\], \[[^]]*\])/\1/p' configure.ac)"
          echo "version=${version}" >> "${GITHUB_OUTPUT}"
      - name: Create source package
        working-directory: ${{ steps.detect.outputs.dir }}
        run: |
          make dist
      - name: Create Linux binary package
        working-directory: ${{ steps.detect.outputs.dir }}
        run: |
          make binary-dist
      - name: Prepare packages to distribution
        working-directory: ${{ steps.detect.outputs.dir }}
        run: |
          # Sanitize variables for security purposes
          safe_name="$(echo "${{ steps.props.outputs.name }}" | tr -cd '[:alnum:]._-' )"
          safe_version="$(echo "${{ steps.props.outputs.version }}" | tr -cd '[:alnum:]._-' )"

          # Check if variables are empty
          [[ -z "$safe_name" ]] && { echo "Invalid name"; exit 1; }
          [[ -z "$safe_version" ]] && { echo "Invalid version"; exit 1; }

          # Check if files exists
          src="${safe_name}-${safe_version}.tar.gz"
          bin="${safe_name}-${safe_version}-bin.tar.gz"
          [[ -f "$src" ]] || { echo "File '${src}' not found"; exit 1; }
          [[ -f "$bin" ]] || { echo "File '${bin}' not found"; exit 1; }

          # Move files
          mkdir -p dist
          mv "${src}" dist/
          mv "${bin}" "dist/${safe_name}-${safe_version}-linux.tar.gz"
  c-cpp-macos-build-template:
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          persist-credentials: false
      - name: Detect working directory
        id: detect
        run: |
          if [[ -d python ]]; then
            echo "dir=python" >> "${GITHUB_OUTPUT}"
          else
            echo "dir=." >> "${GITHUB_OUTPUT}"
          fi
      - name: Install dependencies
        working-directory: ${{ steps.detect.outputs.dir }}
        run: |
          if [[ -s brew-packages.txt ]]; then
            brew update
            xargs brew install < brew-packages.txt
          fi
      - name: Configure and build
        working-directory: ${{ steps.detect.outputs.dir }}
        run: |
          [[ -x ./autogen.sh ]] && ./autogen.sh
          [[ -x ./configure ]] && ./configure
          [[ -s Makefile ]] || {
            echo "I couldn't find an autogen.sh, configure, or Makefile."
            echo "Please check your files."
            exit 1
          }
          make
      - name: Get properties from configure.ac
        working-directory: ${{ steps.detect.outputs.dir }}
        id: props
        run: |
          name="$(sed -n 's/AC_INIT(\[\([^]]*\)\],.*/\1/p' configure.ac)"
          echo "name=${name}" >> "${GITHUB_OUTPUT}"
          version="$(sed -n 's/AC_INIT(\[[^]]*\], \[\([^]]*\)\], \[[^]]*\])/\1/p' configure.ac)"
          echo "version=${version}" >> "${GITHUB_OUTPUT}"
      - name: Create macOS binary package
        working-directory: ${{ steps.detect.outputs.dir }}
        run: |
          make binary-dist
      - name: Prepare package to distribution
        working-directory: ${{ steps.detect.outputs.dir }}
        run: |
          # Sanitize variables for security purposes
          safe_name="$(echo "${{ steps.props.outputs.name }}" | tr -cd '[:alnum:]._-' )"
          safe_version="$(echo "${{ steps.props.outputs.version }}" | tr -cd '[:alnum:]._-' )"

          # Check if variables are empty
          [[ -z "$safe_name" ]] && { echo "Invalid name"; exit 1; }
          [[ -z "$safe_version" ]] && { echo "Invalid version"; exit 1; }

          # Check if file exist
          bin="${safe_name}-${safe_version}-bin.tar.gz"
          [[ -f "$bin" ]] || { echo "File '${bin}' not found"; exit 1; }

          # Move file
          mkdir -p dist
          mv "${bin}" dist/"${safe_name}-${safe_version}-macos.tar.gz"
  c-cpp-windows-build-template:
    runs-on: windows-2025
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          persist-credentials: false
      - name: Install and setup MSYS2 with MinGW64
        uses: msys2/setup-msys2@ee87529e22c13ef957bcd5ef65c3ca2d61025d19
        with:
          msystem: MINGW64
          update: true
          install: >-
            base-devel
            autoconf
            automake
            libtool
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-make
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-libpcap
            mingw-w64-x86_64-tcl
      - name: Detect working directory
        id: detect
        run: |
          if [[ -d python ]]; then
            echo "dir=python" >> "${GITHUB_OUTPUT}"
          else
            echo "dir=." >> "${GITHUB_OUTPUT}"
          fi
      - name: Configure and build
        working-directory: ${{ steps.detect.outputs.dir }}
        shell: msys2 {0}
        run: |
          [[ -x ./autogen.sh ]] && ./autogen.sh
          [[ -x ./configure ]] && ./configure --host=x86_64-w64-mingw64
          [[ -s Makefile ]] || {
            echo "I couldn't find an autogen.sh, configure, or Makefile."
            echo "Please check your files."
            exit 1
          }
          make
      - name: Get properties from configure.ac
        working-directory: ${{ steps.detect.outputs.dir }}
        id: props
        run: |
          name="$(sed -n 's/AC_INIT(\[\([^]]*\)\],.*/\1/p' configure.ac)"
          echo "name=${name}" >> "${GITHUB_OUTPUT}"
          version="$(sed -n 's/AC_INIT(\[[^]]*\], \[\([^]]*\)\], \[[^]]*\])/\1/p' configure.ac)"
          echo "version=${version}" >> "${GITHUB_OUTPUT}"
      - name: Create source package
        working-directory: ${{ steps.detect.outputs.dir }}
        run: |
          make dist
      - name: Create Windows binary package
        working-directory: ${{ steps.detect.outputs.dir }}
        run: |
          make binary-dist
      - name: Prepare packages to distribution
        working-directory: ${{ steps.detect.outputs.dir }}
        run: |
          md dist
          move "${{ steps.props.outputs.name }}-${{ steps.props.outputs.version }}-bin.zip" ^
            "dist/${{ steps.props.outputs.name }}-${{ steps.props.outputs.version }}-windows.zip"
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-dist
          path: dist/*.zip
